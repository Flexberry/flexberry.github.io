---
title: Оптимизация запросов на обновление
sidebar: flexberry-orm_sidebar
keywords: оптимизация, ускорение, ODataBackend, OData, UpdateView, представление для обновления, MasterLightLoad, загрузка мастеров, облегчённая загрузка
summary:
toc: true
permalink: ru/fo_update-optimization.html
lang: ru
---

В работе ODataBackend можно столнуться с задержками при выполнении запросов на обновление если объект имеет множество ссылок на мастер-объекты или большое число детейлов (т.к. все мастера и детейлы загружаются целиком вместе с основным объектом). Эта статья посвящена методам оптимизации запросов на обновление, предлагая рассмотреть два встроенных механизма, предоставляемых ODataBackend:
1. Режим облегченной загрузки мастеров (MasterLightLoad)
2. Настройка представления для обновления объекта (UpdateView)

## Режим облегченной загрузки мастеров (MasterLightLoad)
По умолчанию, во время обновления объекта через [ODataService](fo_orm-odata-service.html) объект загружается из БД вместе со всеми связанными мастерами и детейлами - все мастера и детейлы загружаются целиком вместе с основным объектом. Связанный с объектом мастер может содержать большое количество собственных полей или детейлов, и его загрузка может занимать продолжительное время. В этом случае рекомендуется активировать режим облегчённой загрузки связанных мастеров для исходного объекта.

> **Пример.** Имеется класс `Кошка`, `Лапа` и `Игрушка` (у `Кошки` есть детейл `Лапы`, каждая `Игрушка` принадлежит конкретной `Кошке`). Без режима облегчённой загрузки, при загрузке `Игрушки`, будет загружена связанная `Кошка` со всеми `Лапами`. Активация режима облегчённой загрузки для класса `Игрушка` не будет загружать связанную `Кошку` с её `Лапами`, у связанного мастера (т.е. `Кошки`) будет загружен только `__PrimaryKey`.

### Использование
Задать режим облегчённой загрузки объекта можно на уровне приложения в файле `Startup.cs`, в методе `Configure`. Существует два способа:

1. Глобальная настройка (для всех классов).Необходимо передать параметр `masterLightLoadAllTypes`=`true` в `DefaultDataObjectEdmModelBuilder`:
```csharp
 var modelBuilder = new DefaultDataObjectEdmModelBuilder(assemblies, false, pseudoDetailDefinitions, masterLightLoadAllTypes: true);

 var token = builder.MapDataObjectRoute(modelBuilder);
```

2. Активация режима для некоторых классов. Необходимо передать список классов в параметр конструктора `masterLightLoadTypes` для `DefaultDataObjectEdmModelBuilder`:
```csharp
var masterLightLoadTypes = new List<Type> { typeof(Котенок) }; // <- задаётся список классов для активации режима облегчённой загрузки мастеров

var modelBuilder = new DefaultDataObjectEdmModelBuilder(assemblies, false, pseudoDetailDefinitions, masterLightLoadTypes: masterLightLoadTypes); // список классов передаётся в параметр masterLightLoadTypes

var token = builder.MapDataObjectRoute(modelBuilder);
```
> В случае, если обе настройки активированы одновременно, параметр `masterLightLoadTypes` задающий типы для облегчённой загрузки будет проигнорирован, и настройка будет активна для всех типов объектов данных.

## Представление для обновления (UpdateView)
По умолчанию, при обновлении объекта через [ODataService](fo_orm-odata-service.html), он загружается из БД целиком (со всеми связанными мастерами и детейлами). В случае, если известно, что какие-то атрибуты/мастера/детейлы объекта **никогда не будут обновлены** через ODataBackend, программист имеет возможность указать для объекта `UpdateView` - более экономное представление, которое необходимо использовать при обновлении объекта.

Атрибуты, мастера, детейлы, которые не включены в `UpdateView`, не будут загружены в запросах на обновление объекта через ODataBackend, соответственно, их нельзя обновить через ODataBackend. Кроме того, эти атрибуты, мастера и детейлы не будут загружаться для бизнес-серверов. Несмотря на эти особенности, данная функция может дать прирост к производительности, особенно в случаях, когда объекты содержат множество детейлов.

### Использование
Изменить представление для обновления объекта можно на уровне приложения в файле `Startup.cs`, в методе `Configure`. Необходимо передать представления в параметр конструктора `updateViews` для `DefaultDataObjectEdmModelBuilder`:
```csharp
var updateViews = new Dictionary<Type, View>()
{
    { typeof(Медведь), Медведь.Views.МедведьUpdateView }, // задаётся представление для обновления классу "Медведь"
    { typeof(Берлога), Берлога.Views.БерлогаUpdateView }, // задаётся представление для обновления классу "Берлога"
};
var modelBuilder = new DefaultDataObjectEdmModelBuilder(assemblies, false, pseudoDetailDefinitions, updateViews: updateViews); // представления передаются в параметр updateViews

var token = builder.MapDataObjectRoute(modelBuilder);
```

Для указанных типов объектов данных будет использоваться указанное программистом представление при обновлении объектов через ODataBackend. Для всех остальных типов, которые не переданы в параметр `updateViews`, объекты данных будут обновляться как обычно.
