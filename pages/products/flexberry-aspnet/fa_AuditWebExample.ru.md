---
title: Пример подключения аудита к существующему Web-приложению с использованием перегенерации проекта.
sidebar: flexberry-aspnet_sidebar
keywords: Flexberry ASP-NET, Flexberry Audit, Flexberry Designer
toc: true
permalink: ru/fa_audit-web-example.html

---

{% include note.html content="Если перегенерировать проект нет желания\возможности
смотрите статью *[Пример подключения аудита к существующему Web-приложению без использования перегенерации проекта]*(audit-web-example-manual.html)" %}

## Подключение аудита
Рассмотрим подключение аудита к существующей системе на примере.

### Задача

Добавить аудирование создаваемых и удаляемых объектов в существующую систему. Также необходимо вести аудит изменения для класса Кредит

### Диаграмма классов
![](/images/pages/products/flexberry-aspnet/audit/filter-ex-diagram.png)

### Настройка аудита

*Примечание: требуются версии Flexberry, ASP.NET Generator и Flexberry Web, выпущенные после выполнения [первого этапа](devprocess_audit-stages.html) реализации подсистемы аудита.*

#### Настройка базы данных

Для начала необходимо настроить базу данных аудита.

Откроем форму настройки [MS SQL Direct Generator](configure--m-s--s-q-l--server-direct-generator.html).

![](/images/pages/products/flexberry-aspnet/audit/audit_app-settings.png)


База аудита может храниться как в отдельной базе, так и в базе приложения. Это определяется настройкой `БД аудита в БД приложения`. Предположим, что мы решили хранить данные вместе. Установим эту настройку, а также настройку `Не удалять существующие таблицы` ([подробнее](configure--m-s--s-q-l--server-direct-generator.html)).

Сохраним настройки и закроем форму.

#### Настройка стадии

Откроем форму настройки стадии и перейдем на вкладку Настройка аудита

![](/images/pages/products/flexberry-aspnet/audit/audit-settings-stady.PNG)

* Выберем синхронный режим записи (на [первом этапе](devprocess_audit-stages.html) реализован только синхронный режим записи)
* Нажмем кнопку Включить аудит во всех классах ([подробнее](fd_audit-setup.html))
* Сохраним настройки и закроем форму

#### Настройка классов

Аудит операций создания и удаления включается по умолчанию.

Следовательно, чтобы выполнить поставленную задачу, нам необходимо включить аудит операции изменения для класса Кредит.

Откроем свойства класса Кредит и установим настройку Вести аудит операции изменения.

![](/images/pages/products/flexberry-aspnet/audit/audit-settings-class.jpg)

Сохраним настройки и закроем форму.

#### Настройка класса со стереотипом Application

*Примечание: данные настройки будут актуальны только после реализации [второго этапа](devprocess_audit-stages.html), подробнее смотри [здесь](AuditCaseberrySetup#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F_3)*

### Генерация приложения

Чтобы сгенерировать приложение, необходимо:

* [Привести в соответствие базу данных приложения](fd_matching--d-b--microsoft--s-q-l--server.html)
* Сгенерировать классы
* Скомпилировать классы
* Сгенерировать ASP.NET приложение

### Результат

В проект добавились [web-страницы для отображения аудита](fa_audit-web-forms.html) (данный скриншот актуален для шаблона версии после 18.10.2013):

![](/images/pages/products/flexberry-aspnet/audit/audit-files-in-project.png)


В каждый класс данных (класс со стереотипом [Implementation](fd_data-classes.html)) добавился класс AuditSettings, хранящий настройки аудита для этого класса.

Помимо этого, в классы добавились представления для аудита AuditView, а также 4 новых поля: Creator, CreateTime, Editor, EditTime - последствия выставления настройки Добавить поля аудита ([подробнее](efs_flexberry-audit-object-fields.html)).

#### Просмотр операций аудита

Как уже упоминалось выше, в проекте появились [web-страницы для просмотра данных аудита](fa_audit-web-forms.html). По умолчанию файл конфигурации, отвечающий за эти страницы (файл лежит в папке forms\audit, изображен на рисунке выше), выглядит следующим образом:

```xml
    <authorization>
      <deny users="?"/>
      <allow roles="admin" />
      <deny users="*" />
    </authorization>
```

Что означает, что доступ закрыт для всех пользователей, исключая пользователей с ролью admin ([подробнее в MSDN](https://msdn.microsoft.com/ru-ru/library/8aeskccd(v=vs.90).aspx))

Чтобы не заниматься конфигурированием системы полномочий, изменим файл конфигурации следующим образом:

```xml
    <authorization>
      <deny users="?"/>
    </authorization>
```

Таким образом, доступ к этим страницам будет запрещен только неавторизованным пользователям.

Ссылки на страницу AuditEntityL.aspx можно вынести на [рабочий стол](fa_add-page-to-web-desktop.html) или просто ввести в адресную строку адрес страницы.

На форме можно увидеть стандартный [WebObjectListView](web-object-list-view.html) пока пустой, т.к. аудированных операций еще не было совершено.

Попробуем создать нового Клиента, а затем изменить существующий Кредит, а затем обновим форму отображения данных аудита:

![](/images/pages/products/flexberry-aspnet/audit/audit-wolv.png)

Как можно заметить, фиксируется время и тип операции; объект, над которым была произведена операция (его primaryKey); кем и откуда была произведена операция, а также результат выполнения операции.

## Откуда ссылаются на эту страницу

* [Настройка аудита в Flexberry Designer](fd_audit-setup.html)
* [Миграция со старого аудита на новый]()
* [Flexberry Audit]()

## Куда ссылается эта страницам

* [Добавление собственной формы на рабочий стол Web-приложения](fw_add-form-to-win-desktop.html)
* [Настройка аудита в Flexberry Designer](fd_audit-setup.html)
* [Пример подключения аудита к существующему Web-приложению без использования перегенерации проекта.](efs_audit-web-example-manual.html)
* [Web-формы аудита](fa_audit-web-forms.html)
* [Настройки базы данных]()
* [Классы данных (классы со стереотипом implementation или без указания стереотипа) и их свойства](fd_data-classes.html)
* [Поля аудита](efs_flexberry-audit-object-fields.html)
* [Приведение в соответствие БД Microsoft SQL Server](fd_matching--d-b--microsoft--s-q-l--server.html)
* [WebObjectListView (WOLV)]()