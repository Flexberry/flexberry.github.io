---
title: UserSettingsService
sidebar: flexberry-aspnet_sidebar
keywords: Flexberry UserSettingsService
toc: true
permalink: ru/fa_user-settings-service.html
lang: ru
---

`UserSettingsService` - это сервис, предназначенный для хранения и управления пользовательскими настройками. Он позволяет загружать, сохранять и удалять различные типы настроек (строковые, целочисленные, логические и т.д.) для различных модулей приложения.

1. Позволяет устанавливать, получать и удалять пользовательские настройки. Реализовано несколько полей с различными стандартными типами - удобнее использовать, не требуется затрат на преобразование типов.
2. Реализовано множество перегрузок методов для удобства применения.
3. Есть общие настройки (Common), которые задаются на всё приложение сразу.
4. Реализована поддержка указания настройки как по именам (пользователя, модуля и настройки), так и по уникальным идентификаторам. Эта реализация позволяет в прикладной части иметь соответствующие справочники, которые могут визуально редактироваться и использоваться для управления настройками.
5. Сервис может использоваться как сборка в рамках приложения, так и как WCF-сервис (возможность в разработке).
6. Имеется набор методов для работы с коллекциями настроек (в разработке). Это позволяет реализовывать функциональность вида: "дай мне все настройки пользователя N, чтобы я положил их в свой кэш; удалю из кэша, когда пользователь выйдет из системы".
7. Написание сервиса ведётся с применением Unit-тестирования (NUnit).

`UserSettingsService` использует отдельную таблицу в базе данных для хранения данных и взаимодействует с ней через IDataService.

## Основные компоненты

__1.Класс UserSettingsService:__

* Наследуется от `DataServiceWrapper` и реализует интерфейс `IUserSettingsService`.
* Обеспечивает потокобезопасный доступ к текущему экземпляру службы через свойство Current.

__2.Статическое свойство Current:__

* Предоставляет доступ к единому экземпляру `UserSettingsService`. Если экземпляр еще не создан, он создается автоматически.
* Потокобезопасность обеспечивается с помощью блокировки (`lock`).

__3.Свойства конфигурации:__

* `UseSettings`: Флаг, указывающий, включено ли использование настроек. Значение берется из конфигурационного файла.
* `AppName`: Имя приложения, используется для загрузки данных.

__4.Методы получения имени пользователя из Active Directory (AD):__

* `GetADUserName(string userName)`: Получает полное имя пользователя по его имени учетной записи из AD.
* `GetEnvOrADUserName()`: Получает имя текущего пользователя, используя данные окружения или AD.

## Методы загрузки настроек

__1.Основной метод загрузки настроек:__

* `GetSettings(...)`: Загружает значения настроек по имени и/или идентификатору пользователя и модуля. Поддерживает различные типы значений (строки, текст, числа, булевые значения и т.д.).

__2.Методы загрузки настроек по различным параметрам:__

* `GetAllSettingsByUser(...)`: Загружает все настройки для указанного пользователя.
* `GetAllSettingsNames(...)`: Загружает все имена настроек для указанного модуля и пользователя.
* `GetAllCommonSettings()`: Загружает все общие настройки.
* `GetAllSettingsByModule(...)`: Загружает все настройки для указанного модуля.

## Методы сохранения настроек

__1.Основной метод сохранения настроек:__

* `SetSettings(...)`: Сохраняет значения настроек по имени и/или идентификатору пользователя и модуля. Поддерживает различные типы значений.

__2.Методы сохранения настроек по различным параметрам:__

* `SetStrSetting(...)`, `SetTxtSetting(...)`, `SetIntSetting(...)`, и другие: сохраняют конкретные типы настроек (строки, текст, числа и т.д.).

## Методы удаления настроек

__1.Основной метод удаления настроек:__

* `DeleteSettings(...)`: Удаляет настройки по имени и/или идентификатору пользователя и модуля.

__2.Методы удаления настроек по различным параметрам:__

* `DeleteSettingsByUser(...)`, `DeleteSettingsByModule(...)`, `DeleteCommonSettings(...)`: Удаляют настройки для конкретных пользователей, модулей или общие настройки.

__Пример использования.__

```csharp
// Получение текущего экземпляра сервиса
var userSettingsService = UserSettingsService.Current;

// Загрузка строки настройки
string stringValue;
bool success = userSettingsService.GetStrSetting("JohnDoe", "MyModule", "FontSize", out stringValue);

if (success)
{
    Console.WriteLine($"Font size: {stringValue}");
}
else
{
    Console.WriteLine("Failed to load setting.");
}

// Сохранение строки настройки
bool saveSuccess = userSettingsService.SetStrSetting("JohnDoe", "MyModule", "FontSize", "14px");

if (saveSuccess)
{
    Console.WriteLine("Setting saved successfully.");
}
else
{
    Console.WriteLine("Failed to save setting.");
}

// Удаление настройки
bool deleteSuccess = userSettingsService.DeleteSettings("JohnDoe", null, "MyModule", null, "FontSize", null);

if (deleteSuccess)
{
    Console.WriteLine("Setting deleted successfully.");
}
else
{
    Console.WriteLine("Failed to delete setting.");
}
```

### Класс UserSetting

Класс `UserSetting` представляет собой объект, содержащий информацию о настройке пользователя. Он используется в сервисе `UserSettingsService` для хранения и управления различными типами настроек (строковые, целочисленные, логические и т.д.) в базе данных. Каждый экземпляр UserSetting содержит данные о конкретной настройке, таких как имя приложения, имя пользователя, имя модуля, значение настройки и дата последнего доступа.

Свойства:

* Имя приложения (`AppName`): Строка длиной до 256 символов, представляющая имя приложения.
* Имя пользователя (`UserName`): Строка длиной до 512 символов, представляющая имя пользователя.
* Уникальный идентификатор пользователя (`UserGuid`): Необязательное значение типа Guid, представляющее уникальный идентификатор пользователя.
* Имя модуля (`ModuleName`): Строка длиной до 1024 символов, представляющая имя модуля.
* Уникальный идентификатор модуля (`ModuleGuid`): Необязательное значение типа Guid, представляющее уникальный идентификатор модуля.
* Имя настройки (`SettName`): Строка длиной до 256 символов, представляющая имя настройки.
* Уникальный идентификатор настройки (`SettGuid`): Необязательное значение типа Guid, представляющее уникальный идентификатор настройки.
* Время последнего доступа к настройке (`SettLastAccessTime`): Дата и время последнего доступа к настройке.
* Значение строковой настройки (`StrVal`): Строка длиной до 256 символов, представляющая значение строковой настройки.
* Значение текстовой настройки (`TxtVal`): Строка, представляющая значение текстовой настройки.
* Значение целочисленной настройки (`IntVal`): Необязательное значение типа int, представляющее значение целочисленной настройки.
* Значение логической настройки (`BoolVal`): Необязательное значение типа bool, представляющее значение логической настройки.
* Значение настройки типа Guid (`GuidVal`): Необязательное значение типа Guid, представляющее значение настройки типа Guid.
* Значение десятичной настройки (`DecimalVal`): Необязательное значение типа decimal, представляющее значение десятичной настройки.
* Значение даты и времени настройки (`DateTimeVal`): Необязательное значение типа DateTime, представляющее значение настройки типа дата и время.

__Пример использования__
Пример ниже демонстрирует, как можно использовать класс UserSetting в контексте сервиса UserSettingsService для создания и сохранения пользовательских настроек.

```csharp
using ICSSoft.Services;
using ICSSoft.STORMNET;
using System;

namespace ExampleApp
{
    class Program
    {
        static void Main(string[] args)
        {
            // Получаем текущий экземпляр службы настроек
            IUserSettingsService userSettingsService = UserSettingsService.Current;

            // Создаем новый объект настройки
            var userSetting = new UserSetting
            {
                AppName = "MyApplication",
                UserName = "JohnDoe",
                ModuleName = "SettingsModule",
                SettName = "FontSize",
                StrVal = "14px", // Строковое значение настройки
                SettLastAccessTime = DateTime.Now
            };

            // Сохраняем настройку с использованием сервиса
            bool saveResult = userSettingsService.SetStrSetting("JohnDoe", "SettingsModule", "FontSize", "14px");

            if (saveResult)
            {
                Console.WriteLine("Настройка успешно сохранена.");
            }
            else
            {
                Console.WriteLine("Не удалось сохранить настройку.");
            }

            // Загружаем настройку
            string loadedValue;
            bool loadResult = userSettingsService.GetStrSetting("JohnDoe", "SettingsModule", "FontSize", out loadedValue);

            if (loadResult)
            {
                Console.WriteLine($"Загруженное значение настройки: {loadedValue}");
            }
            else
            {
                Console.WriteLine("Не удалось загрузить настройку.");
            }

            // Удаляем настройку
            bool deleteResult = userSettingsService.DeleteSettings("JohnDoe", null, "SettingsModule", null, "FontSize", null);

            if (deleteResult)
            {
                Console.WriteLine("Настройка успешно удалена.");
            }
            else
            {
                Console.WriteLine("Не удалось удалить настройку.");
            }
        }
    }
}
```
