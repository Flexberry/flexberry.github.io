---
title: Бизнес-серверы и режим отладки
sidebar: guide-practical-guides_sidebar
keywords: guide, C#, ASP.NET, клиент, сервер, бизнес-сервер, flexberry designer, стадия, диаграмма классов, брейкпоинт
toc: true
permalink: ru/gpg_business-servers-and-debug-mode.html
lang: ru
---

При разработке веб-приложений реализация бизнес-логики может выполняться на клиенте (frontend-часть приложения) или на сервере (backend-часть приложения). В связи с этим, при добавлении логики в приложение нужно понимать, в какой из этих частей приложения требуется или будет наиболее целесообразно внести соответствующие изменения.

В многостраничных (MPA) веб-приложениях на клиенте чаще всего настраивается внешний вид приложения, а также реализуется презентационная логика. Под презентационной логикой мы понимаем реакцию приложения на действия пользователя, которая должна следовать непосредственно за действием. Примером такой логики может служить автозаполнение зависимых полей при изменении независимых, валидация и т.д. В одностраничных (SPA) веб-приложениях, коими являются и Ember-приложения, помимо презентационной логики на клиенте реализуется также и основная часть бизнес-логики. Однако часть бизнес-логики для одностраничных приложений может быть реализована также и на сервере. Чаще всего к этой части бизнес-логики обычно относятся дополнительные действия с данными перед их вставкой, измерением или удалением в базе данных.

В данном разделе мы затронем ту часть бизнес-логики, которая реализуется на стороне сервера.

## Создание бизнес-сервера

Для создания бизнес-логики логики в серверной части приложений, реализованных с использованием фреймворка Flexberry Ember, используют **бизнес-серверы** - специальные классы на языке C#, методы которых вызываются при определенных событиях, происходящих со связанным объектом данных - это события добавления, изменения или удаления данных.
Для того, чтобы связать бизнес-сервер с объектом данных, необходимо внести определенные изменения в структуру модели предметной области во **Flexberry Designer**. Для этого перейдем в актуальную для нашего приложения стадию и добавим **новую диаграмму классов "Бизнес-серверы"**:

![Создание диаграммы классов "Бизнес-серверы"](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-1.png)

В диаграмме создайте новый **класс OrderBS** и измените его **стереотип** на **businessserver**:

![Изменение стереотипа класса OrderBS](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-2.png)

Далее нужно привязать бизнес-сервер к нужному нам классу. Для этого сохраните и закройте диаграмму "Бизнес-серверы" и перейдите в **диаграмму "Сущности"**. Здесь необходимо **привязать OrderBS** к классу **Order**:

*`Order → [ПКМ] → ORM: Редактировать свойства → Класс → поле BSClass`*

![Привязка бизнес-сервера OrderBS к классу Order](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-3.png)

В качестве бизнес-сервера выберем созданный нами ранее OrderBS.

Остается только сгенерировать бизнес-сервер. Для этого закрываем с сохранением диаграмму классов "Сущности" и **генерируем бэкенд**, выбрав проект **Shop.BuisnessServers**:

![Генерация бэкенда](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-4.png)

![Генерация бизнес-серверов](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-5.png)

Откроем решение (Solution) с именем **Shop.sln** в **Visual Studio**:

![Генеированный список бизнес-серверов](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-6.png)

Мы видим, что там появился новый проект - бизнес-серверы (**Shop.BuisnessServers**), в который сгенерировался созданный нами бизнес-сервер **OrderBS**. Откроем соответствующий класс:

![Класс OrderBS](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-7.png)

{% include important.html content="В коде обозначены участки, куда разработчик может вносить свой код. При перегенерации эти участки не затираются, а значит, кастомный код не исчезает." %}

По умолчанию в бизнес-сервере генерируется метод **OnUpdate<ИмяКласса>**, который вызывается при выполнении операций вставки, изменения или удаления для соответствующего класса (объекта данных). Однако, пока бизнес-сервер не сопоставлен с классом Order: для этого необходимо также обновить проект с объектами данных. Поэтому, запустим перегенерацию бэкенда еще раз, только на этот раз для объектов:

![Генерация объектов на бэкенд](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-8.png)

**Откроем** класс **Order** в Visual Studio:

*`Shop.Objects → Order.cs`*

![БС OrderBS в классе Order](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-9.png)

Теперь бизнес-сервер OrderBS будет вызываться при любых (OnAllEvents) событиях с экземпляром класса Order.

## Запуск backend в режиме отладки

Одним из важных умений при работе с backend-частью Flexberry Ember-приложения (как, впрочем, и любого другого приложения) является умение "дебажить" - запускать приложение в **режиме отладки** (debug). Данный режим позволяет отслеживать состояние переменных в процессе выполнения кода на бэкенде, а также динамически вносить собственные изменения. До сих пор мы запускали бэкенд приложения без режима отладки (Ctrl + F5).

Для того, чтобы запустить бэкенд приложения в режиме отладки, необходимо выбрать соответствующую **конфигурацию** в верхней панели и **нажать старт**:

![Кнопка режима отладки](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-10.png)

Запустите приложение в режиме отладки.
Одной из ключевых возможностей "дебага" является возможность ставить **[точки останова](https://docs.microsoft.com/ru-ru/visualstudio/debugger/using-breakpoints?view=vs-2019)** (breakpoint / брейкпоинт). Для этого нужно поставить слева от номера строки флажок: перед выполнением этой строки кода программа остановится, ожидая наших дальнейших действий. Поставим **брейкпоинт** на оператор **return** в методе **OnUpdateOrder** (OrderBS):

![Место первого брейкпоинта](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-11.png)

{% include note.html content="Данная функция представляет собой некую &#34;точку расширения&#34;, возвращающую список объектов, которые в БД необходимо обновить. Иными словами, на выходе из OnUpdateOrder возвращается список обновляемых объектов данных, который мы можем пополнять нужными нам объектами, кастомизируя таким образом серверную логику." %}

**Проверим**, как работает режим отладки. Для этого в приложении откроем **Заказ 1** и изменим менеджера на Сидорова (Сидор Сидорович, таб. номер 5). **Сохраним**.

![Останолвенная на месте breakpoint программа](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-12.png)

Автоматически открылось окно Visual Studio, а указанная строка подсветилась. В верхней панели кнопка изменилась на Continue: мы её используем, когда мы будем готовы перейти к следующей точке останова или продолжить выполнение программы. Посмотрим, что представляет собой экземпляр заказа - параметр **UpdatedObject**. Для этого **наведем** на него курсор мыши и **раскроем его содержимое**:

![Содержимое обновляемого объекта UpdatedObject](/images/pages/guides/flexberry-ember/7-1-business-servers-and-debug-mode/7-1-13.png)

Мы видим те изменения, которые мы внесли в заказ прежде, чем его сохранить. В частности, уже изменена ссылка на объект менеджера. 

**Закроем просмотр** объекта, **снимем брейкпоинт** и нажмем **Continue**: мы вернемся к окну браузера.

{% include important.html content="В процессе паузы, возникающей при останове на брейкпоинте, мы можем изменять код. Если вносимые изменения не вызовут ошибок, то код скомпилируется и будет принят к дальнейшему выполнению (если он добавлен после брейкпоинта, то сразу, а если до - при следующей итерации). Не забудьте после добавления участков кода нажимать Ctrl+S для сохранения.<br><br>
Если изменения будут внесены в процессе выполнения программы (не в режиме отладки), то даже после сохранения они не будут приняты к выполнению до тех пор, пока вы не перезапустите приложение или не приостановите его (кнопка &#34;пауза&#34; на панели / Break All / Ctrl+Alt+Break). При этом не все изменения могут быть приняты во время приостановки приложения: подключения сторонних библиотек требуют полного перезапуска приложения." %}

## Итог

В дальнейшем <u>при разработке функционала бизнес-сервера</u> мы будем использовать **режим отладки** и **брейкпоинты**, чтобы контролировать происходящее в бизнес-сервере.

## Перейти

* [Практическое руководство  «Делай как я»](gpg_landing-page.html) <i class="fa fa-arrow-up" aria-hidden="true"></i>

* [Наложение ограничений на лукапы](gpg_lookup-restrictions.html) <i class="fa fa-arrow-left" aria-hidden="true"></i>
* [Реализация серверной логики](gpg_server-logic-implementation.html) <i class="fa fa-arrow-right" aria-hidden="true"></i>