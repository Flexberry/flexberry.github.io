<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ember-flexberry-data/addon/services/syncer.js - Flexberry Documentation</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
	    <img alt="Flexberry Documentation" src="../assets/css/logo.png" style="max-height: 65%;" title="Flexberry Documentation">
            Flexberry Documentation
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>master</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/Adapter", "classes/Adapter.OData", "classes/Adapter.Offline", "classes/ApplicationInitializer", "classes/ApplicationInstanceInitializer", "classes/Audit", "classes/ColsconfigDialogContentComponent", "classes/DecimalTransform", "classes/DetailEditFormController", "classes/DetailInterationService", "classes/DeviceService", "classes/EditFormController", "classes/EditFormNewRoute", "classes/EditFormRoute", "classes/EnumCaptionHelper", "classes/ErrorableControllerMixin", "classes/FileTransform", "classes/FlexberryBaseComponent", "classes/FlexberryCheckboxComponent", "classes/FlexberryDatePicker", "classes/FlexberryDropDown", "classes/FlexberryEnumTransform", "classes/FlexberryField", "classes/FlexberryFileCompatibleComponentMixin", "classes/FlexberryFileComponent", "classes/FlexberryFileControllerMixin", "classes/FlexberryFileViewDialogController", "classes/FlexberryGroupeditComponent", "classes/FlexberryGroupeditRouteMixin", "classes/FlexberryLookup", "classes/FlexberryLookupCompatibleComponent", "classes/FlexberryLookupMixin", "classes/FlexberryMenu", "classes/FlexberryMenuitem", "classes/FlexberryObjectlistview", "classes/FlexberryObjectlistviewHierarchicalControllerMixin", "classes/FlexberryObjectlistviewHierarchicalRouteMixin", "classes/FlexberryObjectlistviewRouteMixin", "classes/FlexberrySimpledatetime", "classes/FlexberryTextarea", "classes/FlexberryTextbox", "classes/FlexberryToggler", "classes/FlexberryValidationmessage", "classes/FlexberryValidationsummary", "classes/GroupEditToolbarComponent", "classes/GuidTransform", "classes/IISCaseberryLoggingObjectsApplicationLogEController", "classes/IISCaseberryLoggingObjectsApplicationLogERoute", "classes/IISCaseberryLoggingObjectsApplicationLogLController", "classes/IISCaseberryLoggingObjectsApplicationLogLRoute", "classes/IISCaseberryLoggingObjectsApplicationLogModel", "classes/IISCaseberryLoggingObjectsApplicationLogSerializer", "classes/LimitedController", "classes/LimitedRouteMixin", "classes/ListFormController", "classes/ListFormRoute", "classes/LockRouteMixin", "classes/LogService", "classes/LookupDialogController", "classes/Mobile.FlexberryFileComponent", "classes/Mobile.FlexberryGroupeditComponent", "classes/Mobile.FlexberryObjectlistview", "classes/Mobile.ObjectListViewComponent", "classes/Mobile.ObjectListViewRowComponent", "classes/ModalApplicationRoute", "classes/ModalDialog", "classes/NewPlatformFlexberryFlexberryUserSettingModel", "classes/NewPlatformFlexberryFlexberryUserSettingSerializer", "classes/NewPlatformFlexberryServicesLockAdapter", "classes/NewPlatformFlexberryServicesLockEditController", "classes/NewPlatformFlexberryServicesLockEditRoute", "classes/NewPlatformFlexberryServicesLockListController", "classes/NewPlatformFlexberryServicesLockListRoute", "classes/NewPlatformFlexberryServicesLockModel", "classes/NewPlatformFlexberryServicesLockSerializer", "classes/ObjectListViewCell", "classes/ObjectListViewComponent", "classes/ObjectlistviewEvents", "classes/ObjectListViewHeaderCell", "classes/ObjectListViewRowComponent", "classes/ObjectListViewSingleColumnCellComponent", "classes/Offline", "classes/Offline.DexieService", "classes/Offline.GlobalsService", "classes/Offline.LocalStore", "classes/Offline.Model", "classes/Offline.ModelMixin", "classes/Offline.Store", "classes/Offline.Syncer", "classes/OlvToolbar", "classes/PaginatedController", "classes/ProjectedModelForm", "classes/Projection", "classes/Projection.AdapterMixin", "classes/Projection.Model", "classes/Projection.StoreMixin", "classes/Query", "classes/Query.BaseAdapter", "classes/Query.BaseBuilder", "classes/Query.BasePredicate", "classes/Query.Builder", "classes/Query.ComplexPredicate", "classes/Query.Condition", "classes/Query.DetailPredicate", "classes/Query.FilterOperator", "classes/Query.IndexedDBAdapter", "classes/Query.JsAdapter", "classes/Query.ODataAdapter", "classes/Query.OrderByClause", "classes/Query.QueryObject", "classes/Query.SimplePredicate", "classes/Query.StringPredicate", "classes/ReloadListMixin", "classes/Resolver", "classes/Security", "classes/Serializer", "classes/Serializer.Base", "classes/Serializer.OData", "classes/Serializer.Offline", "classes/SortableColumn", "classes/SortableControllerMixin", "classes/SortableRoute", "classes/UIMessage", "classes/UserSettingsService", "classes/Utils", "classes/Utils.Information", "classes/ValidationDataObject", "modules/ember-flexberry", "modules/ember-flexberry-data"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
	        <h3>APIs</h3>
	        <div id="sidebar">
	            <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
	                <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
	                <li><a href="#modules" data-toggle="tab">Modules</a></li>
	            </ul>
	    
	            <div id="api-tabview-filter">
	                <input type="search" placeholder="Type to filter APIs">
	            </div>
	    
	            <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
	                <div class="tab-pane active" id="classes">
	                    <ul id="api-classes" class="nav nav-list">
	                            <li><a href="../classes/Adapter.html">Adapter</a></li>
	                            <li><a href="../classes/Adapter.OData.html">Adapter.OData</a></li>
	                            <li><a href="../classes/Adapter.Offline.html">Adapter.Offline</a></li>
	                            <li><a href="../classes/ApplicationInitializer.html">ApplicationInitializer</a></li>
	                            <li><a href="../classes/ApplicationInstanceInitializer.html">ApplicationInstanceInitializer</a></li>
	                            <li><a href="../classes/Audit.html">Audit</a></li>
	                            <li><a href="../classes/ColsconfigDialogContentComponent.html">ColsconfigDialogContentComponent</a></li>
	                            <li><a href="../classes/DecimalTransform.html">DecimalTransform</a></li>
	                            <li><a href="../classes/DetailEditFormController.html">DetailEditFormController</a></li>
	                            <li><a href="../classes/DetailInterationService.html">DetailInterationService</a></li>
	                            <li><a href="../classes/DeviceService.html">DeviceService</a></li>
	                            <li><a href="../classes/EditFormController.html">EditFormController</a></li>
	                            <li><a href="../classes/EditFormNewRoute.html">EditFormNewRoute</a></li>
	                            <li><a href="../classes/EditFormRoute.html">EditFormRoute</a></li>
	                            <li><a href="../classes/EnumCaptionHelper.html">EnumCaptionHelper</a></li>
	                            <li><a href="../classes/ErrorableControllerMixin.html">ErrorableControllerMixin</a></li>
	                            <li><a href="../classes/FileTransform.html">FileTransform</a></li>
	                            <li><a href="../classes/FlexberryBaseComponent.html">FlexberryBaseComponent</a></li>
	                            <li><a href="../classes/FlexberryCheckboxComponent.html">FlexberryCheckboxComponent</a></li>
	                            <li><a href="../classes/FlexberryDatePicker.html">FlexberryDatePicker</a></li>
	                            <li><a href="../classes/FlexberryDropDown.html">FlexberryDropDown</a></li>
	                            <li><a href="../classes/FlexberryEnumTransform.html">FlexberryEnumTransform</a></li>
	                            <li><a href="../classes/FlexberryField.html">FlexberryField</a></li>
	                            <li><a href="../classes/FlexberryFileCompatibleComponentMixin.html">FlexberryFileCompatibleComponentMixin</a></li>
	                            <li><a href="../classes/FlexberryFileComponent.html">FlexberryFileComponent</a></li>
	                            <li><a href="../classes/FlexberryFileControllerMixin.html">FlexberryFileControllerMixin</a></li>
	                            <li><a href="../classes/FlexberryFileViewDialogController.html">FlexberryFileViewDialogController</a></li>
	                            <li><a href="../classes/FlexberryGroupeditComponent.html">FlexberryGroupeditComponent</a></li>
	                            <li><a href="../classes/FlexberryGroupeditRouteMixin.html">FlexberryGroupeditRouteMixin</a></li>
	                            <li><a href="../classes/FlexberryLookup.html">FlexberryLookup</a></li>
	                            <li><a href="../classes/FlexberryLookupCompatibleComponent.html">FlexberryLookupCompatibleComponent</a></li>
	                            <li><a href="../classes/FlexberryLookupMixin.html">FlexberryLookupMixin</a></li>
	                            <li><a href="../classes/FlexberryMenu.html">FlexberryMenu</a></li>
	                            <li><a href="../classes/FlexberryMenuitem.html">FlexberryMenuitem</a></li>
	                            <li><a href="../classes/FlexberryObjectlistview.html">FlexberryObjectlistview</a></li>
	                            <li><a href="../classes/FlexberryObjectlistviewHierarchicalControllerMixin.html">FlexberryObjectlistviewHierarchicalControllerMixin</a></li>
	                            <li><a href="../classes/FlexberryObjectlistviewHierarchicalRouteMixin.html">FlexberryObjectlistviewHierarchicalRouteMixin</a></li>
	                            <li><a href="../classes/FlexberryObjectlistviewRouteMixin.html">FlexberryObjectlistviewRouteMixin</a></li>
	                            <li><a href="../classes/FlexberrySimpledatetime.html">FlexberrySimpledatetime</a></li>
	                            <li><a href="../classes/FlexberryTextarea.html">FlexberryTextarea</a></li>
	                            <li><a href="../classes/FlexberryTextbox.html">FlexberryTextbox</a></li>
	                            <li><a href="../classes/FlexberryToggler.html">FlexberryToggler</a></li>
	                            <li><a href="../classes/FlexberryValidationmessage.html">FlexberryValidationmessage</a></li>
	                            <li><a href="../classes/FlexberryValidationsummary.html">FlexberryValidationsummary</a></li>
	                            <li><a href="../classes/GroupEditToolbarComponent.html">GroupEditToolbarComponent</a></li>
	                            <li><a href="../classes/GuidTransform.html">GuidTransform</a></li>
	                            <li><a href="../classes/IISCaseberryLoggingObjectsApplicationLogEController.html">IISCaseberryLoggingObjectsApplicationLogEController</a></li>
	                            <li><a href="../classes/IISCaseberryLoggingObjectsApplicationLogERoute.html">IISCaseberryLoggingObjectsApplicationLogERoute</a></li>
	                            <li><a href="../classes/IISCaseberryLoggingObjectsApplicationLogLController.html">IISCaseberryLoggingObjectsApplicationLogLController</a></li>
	                            <li><a href="../classes/IISCaseberryLoggingObjectsApplicationLogLRoute.html">IISCaseberryLoggingObjectsApplicationLogLRoute</a></li>
	                            <li><a href="../classes/IISCaseberryLoggingObjectsApplicationLogModel.html">IISCaseberryLoggingObjectsApplicationLogModel</a></li>
	                            <li><a href="../classes/IISCaseberryLoggingObjectsApplicationLogSerializer.html">IISCaseberryLoggingObjectsApplicationLogSerializer</a></li>
	                            <li><a href="../classes/LimitedController.html">LimitedController</a></li>
	                            <li><a href="../classes/LimitedRouteMixin.html">LimitedRouteMixin</a></li>
	                            <li><a href="../classes/ListFormController.html">ListFormController</a></li>
	                            <li><a href="../classes/ListFormRoute.html">ListFormRoute</a></li>
	                            <li><a href="../classes/LockRouteMixin.html">LockRouteMixin</a></li>
	                            <li><a href="../classes/LogService.html">LogService</a></li>
	                            <li><a href="../classes/LookupDialogController.html">LookupDialogController</a></li>
	                            <li><a href="../classes/Mobile.FlexberryFileComponent.html">Mobile.FlexberryFileComponent</a></li>
	                            <li><a href="../classes/Mobile.FlexberryGroupeditComponent.html">Mobile.FlexberryGroupeditComponent</a></li>
	                            <li><a href="../classes/Mobile.FlexberryObjectlistview.html">Mobile.FlexberryObjectlistview</a></li>
	                            <li><a href="../classes/Mobile.ObjectListViewComponent.html">Mobile.ObjectListViewComponent</a></li>
	                            <li><a href="../classes/Mobile.ObjectListViewRowComponent.html">Mobile.ObjectListViewRowComponent</a></li>
	                            <li><a href="../classes/ModalApplicationRoute.html">ModalApplicationRoute</a></li>
	                            <li><a href="../classes/ModalDialog.html">ModalDialog</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryFlexberryUserSettingModel.html">NewPlatformFlexberryFlexberryUserSettingModel</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryFlexberryUserSettingSerializer.html">NewPlatformFlexberryFlexberryUserSettingSerializer</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryServicesLockAdapter.html">NewPlatformFlexberryServicesLockAdapter</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryServicesLockEditController.html">NewPlatformFlexberryServicesLockEditController</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryServicesLockEditRoute.html">NewPlatformFlexberryServicesLockEditRoute</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryServicesLockListController.html">NewPlatformFlexberryServicesLockListController</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryServicesLockListRoute.html">NewPlatformFlexberryServicesLockListRoute</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryServicesLockModel.html">NewPlatformFlexberryServicesLockModel</a></li>
	                            <li><a href="../classes/NewPlatformFlexberryServicesLockSerializer.html">NewPlatformFlexberryServicesLockSerializer</a></li>
	                            <li><a href="../classes/ObjectListViewCell.html">ObjectListViewCell</a></li>
	                            <li><a href="../classes/ObjectListViewComponent.html">ObjectListViewComponent</a></li>
	                            <li><a href="../classes/ObjectlistviewEvents.html">ObjectlistviewEvents</a></li>
	                            <li><a href="../classes/ObjectListViewHeaderCell.html">ObjectListViewHeaderCell</a></li>
	                            <li><a href="../classes/ObjectListViewRowComponent.html">ObjectListViewRowComponent</a></li>
	                            <li><a href="../classes/ObjectListViewSingleColumnCellComponent.html">ObjectListViewSingleColumnCellComponent</a></li>
	                            <li><a href="../classes/Offline.html">Offline</a></li>
	                            <li><a href="../classes/Offline.DexieService.html">Offline.DexieService</a></li>
	                            <li><a href="../classes/Offline.GlobalsService.html">Offline.GlobalsService</a></li>
	                            <li><a href="../classes/Offline.Model.html">Offline.Model</a></li>
	                            <li><a href="../classes/Offline.ModelMixin.html">Offline.ModelMixin</a></li>
	                            <li><a href="../classes/Offline.Store.html">Offline.Store</a></li>
	                            <li><a href="../classes/Offline.Syncer.html">Offline.Syncer</a></li>
	                            <li><a href="../classes/OlvToolbar.html">OlvToolbar</a></li>
	                            <li><a href="../classes/PaginatedController.html">PaginatedController</a></li>
	                            <li><a href="../classes/ProjectedModelForm.html">ProjectedModelForm</a></li>
	                            <li><a href="../classes/Projection.html">Projection</a></li>
	                            <li><a href="../classes/Projection.AdapterMixin.html">Projection.AdapterMixin</a></li>
	                            <li><a href="../classes/Projection.Model.html">Projection.Model</a></li>
	                            <li><a href="../classes/Projection.StoreMixin.html">Projection.StoreMixin</a></li>
	                            <li><a href="../classes/Query.html">Query</a></li>
	                            <li><a href="../classes/Query.BaseAdapter.html">Query.BaseAdapter</a></li>
	                            <li><a href="../classes/Query.BaseBuilder.html">Query.BaseBuilder</a></li>
	                            <li><a href="../classes/Query.BasePredicate.html">Query.BasePredicate</a></li>
	                            <li><a href="../classes/Query.Builder.html">Query.Builder</a></li>
	                            <li><a href="../classes/Query.ComplexPredicate.html">Query.ComplexPredicate</a></li>
	                            <li><a href="../classes/Query.Condition.html">Query.Condition</a></li>
	                            <li><a href="../classes/Query.DetailPredicate.html">Query.DetailPredicate</a></li>
	                            <li><a href="../classes/Query.FilterOperator.html">Query.FilterOperator</a></li>
	                            <li><a href="../classes/Query.IndexedDBAdapter.html">Query.IndexedDBAdapter</a></li>
	                            <li><a href="../classes/Query.JsAdapter.html">Query.JsAdapter</a></li>
	                            <li><a href="../classes/Query.ODataAdapter.html">Query.ODataAdapter</a></li>
	                            <li><a href="../classes/Query.OrderByClause.html">Query.OrderByClause</a></li>
	                            <li><a href="../classes/Query.QueryObject.html">Query.QueryObject</a></li>
	                            <li><a href="../classes/Query.SimplePredicate.html">Query.SimplePredicate</a></li>
	                            <li><a href="../classes/Query.StringPredicate.html">Query.StringPredicate</a></li>
	                            <li><a href="../classes/ReloadListMixin.html">ReloadListMixin</a></li>
	                            <li><a href="../classes/Resolver.html">Resolver</a></li>
	                            <li><a href="../classes/Security.html">Security</a></li>
	                            <li><a href="../classes/Serializer.html">Serializer</a></li>
	                            <li><a href="../classes/Serializer.Base.html">Serializer.Base</a></li>
	                            <li><a href="../classes/Serializer.OData.html">Serializer.OData</a></li>
	                            <li><a href="../classes/Serializer.Offline.html">Serializer.Offline</a></li>
	                            <li><a href="../classes/SortableColumn.html">SortableColumn</a></li>
	                            <li><a href="../classes/SortableControllerMixin.html">SortableControllerMixin</a></li>
	                            <li><a href="../classes/SortableRoute.html">SortableRoute</a></li>
	                            <li><a href="../classes/UIMessage.html">UIMessage</a></li>
	                            <li><a href="../classes/UserSettingsService.html">UserSettingsService</a></li>
	                            <li><a href="../classes/Utils.html">Utils</a></li>
	                            <li><a href="../classes/Utils.Information.html">Utils.Information</a></li>
	                            <li><a href="../classes/ValidationDataObject.html">ValidationDataObject</a></li>
	                    </ul>
	                </div>
	    
	                <div class="tab-pane" id="modules">
	                    <ul id="api-modules" class="nav nav-list">
	                            <li><a href="../modules/ember-flexberry.html">ember-flexberry</a></li>
	                            <li><a href="../modules/ember-flexberry-data.html">ember-flexberry-data</a></li>
	                    </ul>
	                </div>
	            </div>
	        </div>
	    </div>
        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
                    Show:
                    <label for="api-show-inherited" class="checkbox">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected" class="checkbox">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private" class="checkbox">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated" class="checkbox">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </form>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>ember-flexberry-data/addon/services/syncer.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
import Ember from &#x27;ember&#x27;;
import Builder from &#x27;../query/builder&#x27;;
import { SimplePredicate } from &#x27;../query/predicate&#x27;;
import { reloadLocalRecords, createLocalRecord } from &#x27;../utils/reload-local-records&#x27;;
import isModelInstance from &#x27;../utils/is-model-instance&#x27;;
import Queue from &#x27;../utils/queue&#x27;;

const { RSVP, isNone, isArray, getOwner, get } = Ember;

/**
  @class Syncer
  @namespace Offline
  @extends Ember.Object
*/
export default Ember.Service.extend({
  /* Queue of promises for syncDown */
  _syncDownQueue: Queue.create(),

  /* Array of records to be unloaded after syncing down */
  _recordsToUnload: null,

  /**
    Store that use for making requests in offline mode.
    By default it is set to global instane of {{#crossLink &quot;LocalStore&quot;}}{{/crossLink}} class.

    @property offlineStore
    @type &lt;a href=&quot;http://emberjs.com/api/data/classes/DS.Store.html&quot;&gt;DS.Store&lt;/a&gt;
  */
  offlineStore: undefined,

  /**
    Number of &quot;main&quot; records (include related records for relationships) that should be accumulated before bulk operation will be performed.

    @property numberOfRecordsForPerformingBulkOperations
    @type Number
    @default 10
  */
  numberOfRecordsForPerformingBulkOperations: 10,

  /**
    Allows to enable or disable continuation of syncing down if error occurs.

    @property queueContinueOnError
    @type Boolean
    @default true
  */
  queueContinueOnError: true,

  /**
  */
  auditEnabled: true,

  /**
   * Initialize offline store.
   *
   * @method init
   * @private
   */
  init: function() {
    let _this = this;

    let localStore = getOwner(this).lookup(&#x27;store:local&#x27;);

    _this.set(&#x27;offlineStore&#x27;, localStore);
    _this.get(&#x27;_syncDownQueue&#x27;).set(&#x27;continueOnError&#x27;, _this.get(&#x27;queueContinueOnError&#x27;));
    _this.set(&#x27;_recordsToUnload&#x27;, []);
  },

  /**
   * Save specified records into local store (IndexedDB).
   *
   * @method syncDown
   * @public
   * @param {String|DS.Model|Array} descriptor typeName, record, records.
   * @param {Boolean} [reload] If set to true then syncer perform remote reload for data, otherwise data will get from the store.
   * @param {String} [projectionName] Name of projection for remote reload of data. If not set then all properties of record, except navigation properties, will be read.
   * @param {Object} [params] Additional parameters for syncing down.
   * @param {Query.QueryObject} [params.queryObject] QueryObject instance to make query if descriptor is a typeName.
   * @param {Boolean} [params.unloadSyncedRecords] If set to true then synced records will be unloaded from online store.
   * @return {Promise}
   */
  syncDown: function(descriptor, reload, projectionName, params) {
    let _this = this;

    _this.set(&#x27;_recordsToUnload&#x27;, []);

    let bulkUpdateOrCreateCall = (record, resolve, reject) =&gt; {
      let localStore = _this.get(&#x27;offlineStore&#x27;);
      let modelName = record.constructor.modelName;
      let localAdapter = localStore.adapterFor(modelName);
      return localAdapter.bulkUpdateOrCreate(localStore, true, false).then(() =&gt; {
        resolve(record);
      }, reject);
    };

    if (typeof descriptor === &#x27;string&#x27;) {
      return reloadLocalRecords.call(this, descriptor, reload, projectionName, params);

    } else if (isModelInstance(descriptor)) {
      let store = getOwner(this).lookup(&#x27;service:store&#x27;);
      return _this._syncDownQueue.attach((resolve, reject) =&gt; _this._syncDownRecord(store, descriptor, reload, projectionName, params).then(() =&gt;
        bulkUpdateOrCreateCall(descriptor, resolve, reject), reject).then(() =&gt; _this._unloadRecordsAfterSyncDown(store, params)));
    } else if (isArray(descriptor)) {
      let store = getOwner(this).lookup(&#x27;service:store&#x27;);
      let recordsCount =  descriptor.get ? descriptor.get(&#x27;length&#x27;) : descriptor.length;
      let accumulatedRecordsCount = 0;
      let updatedRecords = descriptor.map(function(record) {
        return _this._syncDownQueue.attach((resolve, reject) =&gt; _this._syncDownRecord(store, record, reload, projectionName, params).then(() =&gt; {
          accumulatedRecordsCount++;
          if ((accumulatedRecordsCount % _this.numberOfRecordsForPerformingBulkOperations === 0) || accumulatedRecordsCount === recordsCount) {
            return bulkUpdateOrCreateCall(record, resolve, reject);
          } else {
            resolve(record);
          }
        }, reject));
      });
      return RSVP.all(updatedRecords).then(() =&gt; _this._unloadRecordsAfterSyncDown(store, params));

    } else {
      throw new Error(&#x27;Input for sync down can only be a string, a DS.Model or an array of DS.Model, but is &#x27; + descriptor);
    }
  },

  /**
   * Remove all records in local store.
   *
   * @method
   * @public
   */
  reset: function() {
    return this.get(&#x27;offlineStore.adapter&#x27;).clear();
  },

  /**
   * Saves data to local store.
   *
   * @method _syncDownRecord
   * @param {DS.Store or Subclass} store Store of application.
   * @param {DS.Model} record Record to save in local store.
   * @param {Boolean} [reload] If set to true then syncer perform remote reload for data, otherwise data will get from the store.
   * @param {String} [projectionName] Name of projection for remote reload of data. If not set then all properties of record, except navigation properties, will be read.
   * @param {Object} [params] Additional parameters for syncing down.
   * @param {Query.QueryObject} [params.queryObject] QueryObject instance to make query if descriptor is a typeName.
   * @param {Boolean} [params.unloadSyncedRecords] If set to true then synced records will be unloaded from online store.
   * @private
   */
  _syncDownRecord: function(store, record, reload, projectionName, params) {
    var _this = this;

    function saveRecordToLocalStore(store, record, projectionName) {
      let modelName = record.constructor.modelName;
      let modelType = store.modelFor(modelName);
      let projection = isNone(projectionName) ? null : modelType.projections[projectionName];
      let localStore = this.get(&#x27;offlineStore&#x27;);
      let localAdapter = localStore.adapterFor(modelName);

      if (record.get(&#x27;isDeleted&#x27;)) {
        let snapshot = record._createSnapshot();
        return localAdapter.deleteRecord(localStore, snapshot.type, snapshot).then(() =&gt; {
          let dexieService = getOwner(_this).lookup(&#x27;service:dexie&#x27;);
          dexieService.set(&#x27;queueSyncDownWorksCount&#x27;, dexieService.get(&#x27;queueSyncDownWorksCount&#x27;) - 1);
          return record;
        }).catch((reason) =&gt; {
          return Ember.RSVP.reject(reason);
        });
      } else {
        return createLocalRecord.call(_this, store, localAdapter, localStore, modelType, record, projection, params);
      }
    }

    if (reload) {
      let modelName = record.constructor.modelName;
      let options = {
        reload: true,
        useOnlineStore: true
      };
      options = isNone(projectionName) ? options : Ember.$.extend(true, options, { projection: projectionName });
      return new Ember.RSVP.Promise((resolve, reject) =&gt; {
        store.findRecord(modelName, record.id, options).then(function(reloadedRecord) {

          // TODO: Uncomment this after fix bug with load unloaded models.
          // store.get(&#x27;onlineStore&#x27;).unloadRecord(reloadedRecord);
          saveRecordToLocalStore.call(_this, store, reloadedRecord, projectionName).then(() =&gt; {
            resolve(record);
          }, reject);
        });
      });
    } else {
      return saveRecordToLocalStore.call(_this, store, record, projectionName);
    }
  },

  /**
    Start sync up process.

    @method syncUp
    @param {Ember.Array} [jobs] Array instances of &#x60;auditEntity&#x60; model for sync up.
    @param {Object} [options] Object with options for sync up.
    @param {Boolean} [options.continueOnError] If &#x60;true&#x60; continue sync up if an error occurred.
    @return {Promise}
  */
  syncUp(jobs, options) {
    let builder;
    let predicate;
    let store = getOwner(this).lookup(&#x27;service:store&#x27;);
    let dexieService = getOwner(this).lookup(&#x27;service:dexie&#x27;);
    let modelName = &#x27;i-c-s-soft-s-t-o-r-m-n-e-t-business-audit-objects-audit-entity&#x27;;
    if (!jobs) {
      predicate = new SimplePredicate(&#x27;executionResult&#x27;, &#x27;eq&#x27;, &#x27;Unexecuted&#x27;)
        .or(new SimplePredicate(&#x27;executionResult&#x27;, &#x27;eq&#x27;, &#x27;Failed&#x27;));
      builder = new Builder(store, modelName)
        .selectByProjection(&#x27;AuditEntityE&#x27;)
        .orderBy(&#x27;operationTime&#x27;)
        .where(predicate);
    }

    return (jobs ? RSVP.resolve(jobs) : this.get(&#x27;offlineStore&#x27;).query(modelName, builder.build())).then((jobs) =&gt; {
      dexieService.set(&#x27;queueSyncUpTotalWorksCount&#x27;, jobs.get(&#x27;length&#x27;));
      return this._runJobs(store, jobs, options &amp;&amp; options.continueOnError);
    });
  },

  /**
    This method is called when a sync process if at attempt create, update or delete record, server error return.
    Default behavior: Marked &#x60;job&#x60; as &#x27;Ошибка&#x27;, execute further when called &#x60;syncUp&#x60; method.

    @example
      &#x60;&#x60;&#x60;javascript
      // app/services/syncer.js
      import { Offline } from &#x27;ember-flexberry-data&#x27;;

      export default Offline.Syncer.extend({
        ...
        resolveServerError(job, error) {
          let _this = this;
          return new Ember.RSVP.Promise((resolve, reject) =&gt; {
            // Here &#x60;error.status&#x60; as example, as if user not authorized on server.
            if (error.status === 401) {
              // As if &#x60;auth&#x60; function authorize user.
              auth().then(() =&gt; {
                _this.syncUp(Ember.A([job])).then(() =&gt; {
                  job.set(&#x27;executionResult&#x27;, &#x27;Выполнено&#x27;);
                  resolve(job.save());
                }, reject);
              }, reject);
            } else {
              job.set(&#x27;executionResult&#x27;, &#x27;Ошибка&#x27;);
              resolve(job.save());
            }
          });
        },
        ...
      });

      &#x60;&#x60;&#x60;

    @method resolveServerError
    @param {subclass of DS.Model} job Instance of &#x60;auditEntity&#x60; model when restore which error occurred.
    @param {Object} error
    @return {Promise} Promise that resolves updated job.
  */
  resolveServerError(job, error) {
    Ember.debug(&#x60;Error sync up:&#x27;${job.get(&#x27;operationType&#x27;)}&#x27; - &#x27;${job.get(&#x27;objectType.name&#x27;)}:${job.get(&#x27;objectPrimaryKey&#x27;)}&#x27;.&#x60;, error);
    job.set(&#x27;executionResult&#x27;, &#x27;Ошибка&#x27;);
    return job.save();
  },

  /**
    This method is called when a sync process not found record on server for delete or update.
    Default behavior: Marked &#x60;job&#x60; as &#x27;Не выполнено&#x27;, not delete and not execute further when called &#x60;syncUp&#x60; method.

    @example
      &#x60;&#x60;&#x60;javascript
      // app/services/syncer.js
      import { Offline } from &#x27;ember-flexberry-data&#x27;;

      export default Offline.Syncer.extend({
        ...
        resolveNotFoundRecord(job) {
          if (job.get(&#x27;operationType&#x27;) === &#x27;UPDATE&#x27;) {
            // It will be executed when next called &#x60;syncUp&#x60; method.
            job.set(&#x27;executionResult&#x27;, &#x27;Ошибка&#x27;);
          } else if (job.get(&#x27;operationType&#x27;) === &#x27;DELETE&#x27;) {
            // It will be immediately delete and not never executed.
            job.set(&#x27;executionResult&#x27;, &#x27;Выполнено&#x27;);
          }

          return job.save();
        },
        ...
      });

      &#x60;&#x60;&#x60;

    @method resolveNotFoundRecord
    @param {subclass of DS.Model} job Instance of &#x60;auditEntity&#x60; model when restore which error occurred.
    @return {Promise} Promise that resolves updated job.
  */
  resolveNotFoundRecord(job) {
    job.set(&#x27;executionResult&#x27;, &#x27;Не выполнено&#x27;);
    return job.save();
  },

  /**
  */
  createJob(record) {
    return new RSVP.Promise((resolve, reject) =&gt; {
      this._createAuditEntity(record).then((auditEntity) =&gt; {
        this._createAuditFields(auditEntity, record).then(resolve, reject);
      });
    });
  },

  /**
  */
  _runJobs(store, jobs, continueOnError, jobCount) {
    let _this = this;
    let dexieService = getOwner(_this).lookup(&#x27;service:dexie&#x27;);
    dexieService.set(&#x27;queueSyncUpWorksCount&#x27;, jobs.get(&#x27;length&#x27;));
    let job = jobs.shiftObject();
    let executedJob = jobCount || 0;
    return new RSVP.Promise((resolve, reject) =&gt; {
      if (job) {
        _this._runJob(store, job).then((job) =&gt; {
          _this._endJob(job).then(() =&gt; {
            resolve(_this._runJobs(store, jobs, continueOnError, ++executedJob));
          }).catch((reason) =&gt; {
            if (continueOnError) {
              resolve(_this._runJobs(store, jobs, continueOnError, executedJob));
            } else {
              reject(reason);
            }
          });
        }, reject);
      } else {
        dexieService.set(&#x27;queueSyncUpWorksCount&#x27;, 0);
        resolve(executedJob);
      }
    });
  },

  /**
  */
  _endJob(job) {
    let dexieService = getOwner(this).lookup(&#x27;service:dexie&#x27;);
    return new RSVP.Promise((resolve, reject) =&gt; {
      if (job.get(&#x27;executionResult&#x27;) === &#x27;Выполнено&#x27;) {
        RSVP.all(job.get(&#x27;auditFields&#x27;).map(field =&gt; field.destroyRecord())).then(() =&gt; {
          dexieService.set(&#x27;queueSyncUpCurrentModelName&#x27;, null);
          resolve(job.destroyRecord());
        }, reject);
      } else {
        reject(job);
      }
    });
  },

  /**
  */
  _runJob(store, job) {
    let dexieService = getOwner(this).lookup(&#x27;service:dexie&#x27;);
    dexieService.set(&#x27;queueSyncUpCurrentModelName&#x27;, job.get(&#x27;objectType.name&#x27;));

    switch (job.get(&#x27;operationType&#x27;)) {
      case &#x27;INSERT&#x27;: return this._runCreatingJob(store, job);
      case &#x27;UPDATE&#x27;: return this._runUpdatingJob(store, job);
      case &#x27;DELETE&#x27;: return this._runRemovingJob(store, job);
      default: throw new Error(&#x27;Unsupported operation type.&#x27;);
    }
  },

  /**
  */
  _runCreatingJob(store, job) {
    let record = store.peekRecord(job.get(&#x27;objectType.name&#x27;), job.get(&#x27;objectPrimaryKey&#x27;));
    if (record) {
      store.unloadRecord(record);
    }

    record = store.createRecord(job.get(&#x27;objectType.name&#x27;), { id: job.get(&#x27;objectPrimaryKey&#x27;) });
    record.set(&#x27;isSyncingUp&#x27;, true);
    record.set(&#x27;isCreatedDuringSyncUp&#x27;, true);

    return this._changesForRecord(store, job).then((changes) =&gt; {
      record.setProperties(changes);
      return record.save().then(() =&gt; {
        job.set(&#x27;executionResult&#x27;, &#x27;Выполнено&#x27;);
        return job.save();
      }).catch(reason =&gt; this.resolveServerError(job, reason)).finally(() =&gt; {
        if (record) {
          record.set(&#x27;isSyncingUp&#x27;, false);
        }
      });
    });
  },

  /**
  */
  _runUpdatingJob(store, job) {
    let query = this._createQuery(store, job);
    return store.queryRecord(query.modelName, query).then((record) =&gt; {
      if (record) {
        record.set(&#x27;isSyncingUp&#x27;, true);
        return this._changesForRecord(store, job).then((changes) =&gt; {
          record.setProperties(changes);
          return record.save().then(() =&gt; {
            record.set(&#x27;isUpdatedDuringSyncUp&#x27;, true);
            job.set(&#x27;executionResult&#x27;, &#x27;Выполнено&#x27;);
            return job.save();
          }).catch(reason =&gt; this.resolveServerError(job, reason)).finally(() =&gt; {
            if (record) {
              record.set(&#x27;isSyncingUp&#x27;, false);
            }
          });
        });
      } else {
        return this.resolveNotFoundRecord(job);
      }
    });
  },

  /**
  */
  _runRemovingJob(store, job) {
    let query = this._createQuery(store, job);
    return store.queryRecord(query.modelName, query).then((record) =&gt; {
      if (record) {
        record.set(&#x27;isSyncingUp&#x27;, true);
        return record.destroyRecord().then(() =&gt; {
          record.set(&#x27;isDestroyedDuringSyncUp&#x27;, true);
          job.set(&#x27;executionResult&#x27;, &#x27;Выполнено&#x27;);
          return job.save();
        }).catch(reason =&gt; this.resolveServerError(job, reason)).finally(() =&gt; {
          if (record) {
            record.set(&#x27;isSyncingUp&#x27;, false);
          }
        });
      } else {
        return this.resolveNotFoundRecord(job);
      }
    });
  },

  /**
  */
  _createAuditEntity(record) {
    let _this = this;
    return _this._auditDataFromRecord(record).then(
      auditData =&gt; _this.get(&#x27;auditEnabled&#x27;) ? _this._newAuditEntity(auditData) : _this._updateAuditEntity(auditData)
    );
  },

  /**
  */
  _newAuditEntity(auditData) {
    return this.get(&#x27;offlineStore&#x27;).createRecord(&#x27;i-c-s-soft-s-t-o-r-m-n-e-t-business-audit-objects-audit-entity&#x27;, auditData).save();
  },

  /**
  */
  _updateAuditEntity(auditData) {
    let _this = this;
    return _this.get(&#x27;offlineStore&#x27;).query(&#x27;i-c-s-soft-s-t-o-r-m-n-e-t-business-audit-objects-audit-entity&#x27;, {
      objectPrimaryKey: auditData.objectPrimaryKey,
    }).then((auditEntities) =&gt; {
      if (auditEntities.get(&#x27;length&#x27;)) {
        let auditEntity = auditEntities.get(&#x27;firstObject&#x27;);
        return RSVP.all(auditEntity.get(&#x27;auditFields&#x27;).map(field =&gt; field.destroyRecord())).then(() =&gt; {
          if (auditData.operationType === &#x27;DELETE&#x27; &amp;&amp; auditEntity.get(&#x27;operationType&#x27;) === &#x27;INSERT&#x27;) {
            return auditEntity.destroyRecord();
          } else {
            if (auditEntity.get(&#x27;operationType&#x27;) === &#x27;INSERT&#x27;) {
              delete auditData.operationType;
            }

            auditEntity.setProperties(auditData);
            return auditEntity.save();
          }
        });
      } else {
        return _this._newAuditEntity(auditData);
      }
    });
  },

  /**
  */
  _createAuditFields(auditEntity, record) {
    let promises = [];
    if (auditEntity.get(&#x27;operationType&#x27;) !== &#x27;DELETE&#x27;) {
      let changes = this._changesFromRecord(record);
      for (let change in changes) {
        promises.push(this._createAuditField(auditEntity, change, changes[change]));
      }
    }

    return RSVP.all(promises).then((fields) =&gt; {
      auditEntity.set(&#x27;auditFields&#x27;, fields);
      return auditEntity.save();
    });
  },

  /**
  */
  _createAuditField(auditEntity, attributeName, attributeData) {
    let _this = this;
    return _this.get(&#x27;offlineStore&#x27;).createRecord(&#x27;i-c-s-soft-s-t-o-r-m-n-e-t-business-audit-objects-audit-field&#x27;, {
      field: attributeName,
      oldValue: attributeData[0],
      newValue: attributeData[1],
      auditEntity: auditEntity,
    }).save();
  },

  /**
  */
  _auditDataFromRecord(record) {
    let _this = this;
    let userService = getOwner(_this).lookup(&#x27;service:user&#x27;);
    let operationType = _this._getOperationType(record.get(&#x27;dirtyType&#x27;));
    return userService.getCurrentUser().then(currentUser =&gt; _this._getObjectType(record._createSnapshot().modelName).then(objectType =&gt; ({
          objectPrimaryKey: record.get(&#x27;id&#x27;),
          operationTime: new Date(),
          operationType: operationType,
          executionResult: &#x27;Не выполнено&#x27;,
          createTime: record.get(&#x27;createTime&#x27;),
          creator: record.get(&#x27;creator&#x27;),
          editTime: record.get(&#x27;editTime&#x27;),
          editor: record.get(&#x27;editor&#x27;),
          user: currentUser,
          objectType: objectType,
        })
      )
    );
  },

  /**
  */
  _getObjectType(objectTypeName) {
    let _this = this;
    return _this.get(&#x27;offlineStore&#x27;).query(&#x27;i-c-s-soft-s-t-o-r-m-n-e-t-business-audit-objects-object-type&#x27;, {
      name: objectTypeName,
    }).then((objectTypes) =&gt; {
      if (objectTypes.get(&#x27;length&#x27;)) {
        return new RSVP.resolve(objectTypes.get(&#x27;firstObject&#x27;));
      } else {
        return _this.get(&#x27;offlineStore&#x27;).createRecord(&#x27;i-c-s-soft-s-t-o-r-m-n-e-t-business-audit-objects-object-type&#x27;, {
          name: objectTypeName,
        }).save();
      }
    });
  },

  /**
  */
  _getOperationType(dirtyType) {
    switch (dirtyType) {
      case &#x27;created&#x27;: return &#x27;INSERT&#x27;;
      case &#x27;updated&#x27;: return &#x27;UPDATE&#x27;;
      case &#x27;deleted&#x27;: return &#x27;DELETE&#x27;;
      default: throw new Error(&#x27;Unknown dirty type.&#x27;);
    }
  },

  /**
  */
  _changesForRecord(store, job) {
    return new RSVP.Promise((resolve, reject) =&gt; {
      let changes = {};
      let promises = [];
      let attributes = get(store.modelFor(job.get(&#x27;objectType.name&#x27;)), &#x27;attributes&#x27;);
      job.get(&#x27;auditFields&#x27;).forEach((auditField) =&gt; {
        let descriptorField = auditField.get(&#x27;field&#x27;).split(&#x27;@&#x27;);
        let field = descriptorField.shift();
        let type = descriptorField.shift();
        if (type) {
          let builder = new Builder(store, type).byId(auditField.get(&#x27;newValue&#x27;));
          promises.push(store.queryRecord(type, builder.build()).then((relationship) =&gt; {
            changes[field] = relationship;
          }));
        } else {
          let value = auditField.get(&#x27;newValue&#x27;);
          switch (attributes.get(field).type) {
            case &#x27;boolean&#x27;:
              changes[field] = value === null ? null : !!value;
              break;

            case &#x27;number&#x27;:
              changes[field] = value === null ? null : +value;
              break;

            case &#x27;date&#x27;:
              changes[field] = value === null ? null : new Date(value);
              break;

            default:
              changes[field] = value;
          }
        }
      });

      RSVP.all(promises).then(() =&gt; {
        resolve(changes);
      }, reject);
    });
  },

  /**
  */
  _changesFromRecord(record) {
    let changes = {};
    if (this.get(&#x27;auditEnabled&#x27;)) {
      let changedAttributes = record.changedAttributes();
      for (let attribute in changedAttributes) {
        changes[attribute] = changedAttributes[attribute];
      }
    } else {
      record.eachAttribute((name) =&gt; {
        let value = record.get(name);
        if (value) {
          changes[name] = [null, value];
        }
      });
    }

    let changedRelationships = record.changedBelongsTo();
    let snapshot = record._createSnapshot();
    record.eachRelationship((name, descriptor) =&gt; {
      let changedRelationship = changedRelationships[name];
      if (changedRelationship &amp;&amp; descriptor.kind === &#x27;belongsTo&#x27;) {
        let relationshipType = descriptor.type;
        if (descriptor.options &amp;&amp; descriptor.options.polymorphic) {
          let belongsTo = snapshot.belongsTo(descriptor.key);
          relationshipType = belongsTo.modelName;
        }

        changes[&#x60;${name}@${relationshipType}&#x60;] = [
          changedRelationship[0] &amp;&amp; changedRelationship[0].get(&#x27;id&#x27;),
          changedRelationship[1] &amp;&amp; changedRelationship[1].get(&#x27;id&#x27;),
        ];
      }
    });

    return changes;
  },

  /**
  */
  _createQuery(store, job) {
    //TODO: Get projection for sync up from generated list of projections for models.
    let modelName = job.get(&#x27;objectType.name&#x27;);
    let modelClass = store.modelFor(modelName);
    let projectionName = modelName.indexOf(&#x27;-&#x27;) &gt; -1 ? modelName.substring(modelName.indexOf(&#x27;-&#x27;) + 1) : modelName;
    projectionName = projectionName.camelize().capitalize() + &#x27;E&#x27;;

    let builder = new Builder(store).from(modelName);
    if (modelClass.projections &amp;&amp; modelClass.projections.get(projectionName)) {
      builder = builder.selectByProjection(projectionName);
    }

    builder = builder.byId(job.get(&#x27;objectPrimaryKey&#x27;));
    let query = builder.build();
    query.useOnlineStore = true;
    return query;
  },

  /**
  */
  _unloadRecordsAfterSyncDown(store, params) {
    let recordsToUnload = this.get(&#x27;_recordsToUnload&#x27;);
    if (params &amp;&amp; params.unloadSyncedRecords &amp;&amp; recordsToUnload.length &gt; 0) {
      for (let i = 0; i &lt; recordsToUnload.length; i++) {
        let record = recordsToUnload[i];
        if (record.get(&#x27;hasDirtyAttributes&#x27;)) {
          record.rollbackAttributes();
        }

        if (!record.get(&#x27;isDeleted&#x27;)) {
          if (store.get(&#x27;onlineStore&#x27;)) {
            store.get(&#x27;onlineStore&#x27;).unloadRecord(record);
          } else {
            store.unloadRecord(record);
          }
        }
      }

      this.set(&#x27;_recordsToUnload&#x27;, []);
    }

    return Ember.RSVP.resolve();
  }
});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
